<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Pesan</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.0/dist/sweetalert2.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --htmlFontSize: 100%;
        --bodyBackgroundColor: #2c3338;
        --bodyColor: var(--baseColor);
        --bodyFontFamily: "Open Sans";
        --bodyFontFamilyFallback: sans-serif;
        --bodyFontSize: 0.875rem;
        --bodyFontWeight: 400;
        --bodyLineHeight: 1.5;
        --buttonColor: #fff;
        --buttonBackgroundColor: #ea4c88;
        --buttonHoverColor: #fff;
        --buttonHoverBackgroundColor: #d44179;
      }

      * {
        box-sizing: inherit;
      }

      html {
        box-sizing: border-box;
        font-size: var(--htmlFontSize);
      }

      body {
        background-color: var(--bodyBackgroundColor);
        color: var(--bodyColor);
        font-family: var(--bodyFontFamily), var(--bodyFontFamilyFallback);
        font-size: var(--bodyFontSize);
        font-weight: var(--bodyFontWeight);
        line-height: var(--bodyLineHeight);
        margin: 0;
        min-block-size: 100vh;
      }

      #header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 1rem;
        background-color: var(--bodyBackgroundColor);
        color: var(--bodyColor);
      }

      #header button {
        padding: 0.5rem 1rem;
        background-color: var(--buttonBackgroundColor);
        color: var(--buttonColor);
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
      }

      #header button:hover {
        background-color: var(--buttonHoverBackgroundColor);
        color: var(--buttonHoverColor);
      }

      #messageDetails {
        padding: 2rem;
        color: var(--bodyColor);
      }

      h1 {
        color: #ffffff;
        text-align: center;
      }

      h2 {
        color: var(--bodyColor);
        text-align: center;
      }

      .messageDetailsContainer {
        padding: 1rem;
        background-color: #3b4148;
        border-radius: 0.5rem;
        color: #fff;
      }

      .messageDetailsContainer strong {
        color: #ea4c88;
      }

      @media (max-width: 768px) {
        #messageDetails {
          padding: 1rem;
        }
      }

      /* Menambahkan style untuk menangani teks panjang */
      #messageDetails {
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        padding: 20px;
      }

      #messageDetails a {
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
      }

      /* Styling untuk tombol Hapus Pesan */
      #deleteMessageButton {
        padding: 0.5rem 1rem;
        background-color: var(--buttonBackgroundColor);
        color: var(--buttonColor);
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
        margin-top: 20px;
      }

      #deleteMessageButton:hover {
        background-color: var(--buttonHoverBackgroundColor);
        color: var(--buttonHoverColor);
      }
    </style>
  </head>
  <body>
    <div id="header">
      <button onclick="signOut()">Sign Out</button>
    </div>
    <h1>Detail Pesan</h1>
    <div id="messageDetails">
      <!-- Detail pesan akan ditampilkan di sini -->
    </div>
    <!-- Tombol Hapus Pesan -->
    <button
      id="deleteMessageButton"
      onclick="deleteMessage()"
      style="margin-left: 20px"
    >
      Hapus Pesan
    </button>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.0/dist/sweetalert2.min.js"></script>
    <script>
      const token = localStorage.getItem("token");
      const messageId = new URLSearchParams(window.location.search).get(
        "messageId"
      );

      // Tentukan domain API default
      const apiDomain = "https://api.mail.tm"; // Default api.mail.tm

      // Ganti domain ini jika ingin beralih ke api.mail.gw
      // const apiDomain = "https://api.mail.gw"; // Contoh jika ingin menggunakan api.mail.gw

      if (!token) {
        alert("Anda perlu login terlebih dahulu!");
        window.location.href = "https://mail.Arufkuy.my.id";
      }

      // Fungsi untuk mengambil detail pesan
      async function getMessageDetails() {
        try {
          const response = await fetch(`${apiDomain}/messages/${messageId}`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const messageDetails = await response.json();
          if (response.ok) {
            document.getElementById("messageDetails").innerHTML = `
              <div class="messageDetailsContainer">
                <strong>Pengirim:</strong> ${messageDetails.from.name} (${
              messageDetails.from.address
            })<br>
                <strong>Subjek:</strong> ${messageDetails.subject}<br>
                <strong>Pesan:</strong> <br>${messageDetails.text}
                ${
                  messageDetails.attachments
                    ? `<br><strong>Lampiran:</strong> <a href="${messageDetails.attachments[0].url}" target="_blank">Download Lampiran</a>`
                    : ""
                }
              </div>
            `;

            // Menampilkan tombol Hapus Pesan setelah pesan berhasil dimuat
            document.getElementById("deleteMessageButton").style.display =
              "inline-block";

            // Setelah pesan berhasil dimuat, tandai sebagai telah dibaca
            markAsRead();
          } else {
            alert("Gagal mengambil detail pesan.");
          }
        } catch (error) {
          console.error(error);
          alert("Terjadi kesalahan dalam memuat detail pesan.");
        }
      }

      getMessageDetails();

      function markAsRead() {
        // Tambahkan logika jika perlu untuk menandai pesan sebagai telah dibaca
      }

      // Fungsi untuk menghapus pesan
      async function deleteMessage() {
        const confirmDelete = await Swal.fire({
          title: "Apakah Anda yakin ingin menghapus pesan ini?",
          text: "Pesan yang sudah dihapus tidak bisa dipulihkan!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Hapus",
          cancelButtonText: "Batal",
        });

        if (confirmDelete.isConfirmed) {
          try {
            const response = await fetch(`${apiDomain}/messages/${messageId}`, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            if (response.ok) {
              Swal.fire({
                icon: "success",
                title: "Pesan berhasil dihapus!",
                text: "Pesan ini telah dihapus.",
              }).then(() => {
                window.location.href = "https://mail.arufkuy.my.id/inbox.html"; // Arahkan ke inbox setelah hapus
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "Gagal menghapus pesan!",
                text: "Terjadi kesalahan saat menghapus pesan.",
              });
            }
          } catch (error) {
            Swal.fire({
              icon: "error",
              title: "Terjadi kesalahan!",
              text: "Coba lagi nanti.",
            });
          }
        }
      }

      function signOut() {
        localStorage.removeItem("token");
        window.location.href = "https://mail.Arufkuy.my.id";
      }
    </script>
  </body>
</html>
